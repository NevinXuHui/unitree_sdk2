# CycloneDDS 环境变量标准格式

## 标准配置格式

所有脚本和配置文件已统一使用以下标准格式：

### 环境变量格式（内联 XML）

```bash
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><AllowMulticast>spdp</AllowMulticast><Interfaces><NetworkInterface name="<接口名>" priority="default" multicast="default"/></Interfaces></General></Domain></CycloneDDS>'
```

### XML 配置文件格式

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CycloneDDS xmlns="https://cdds.io/config">
  <Domain>
    <General>
      <!-- 网络接口配置 -->
      <Interfaces>
        <NetworkInterface name="<接口名>" priority="default" multicast="default"/>
      </Interfaces>
      
      <!-- 组播配置 - 仅用于 SPDP (服务发现) -->
      <AllowMulticast>spdp</AllowMulticast>
    </General>
  </Domain>
</CycloneDDS>
```

## 配置参数说明

### `<AllowMulticast>spdp</AllowMulticast>`

- **用途**：控制组播的使用范围
- **spdp**：仅在 SPDP（Simple Participant Discovery Protocol，简单参与者发现协议）中使用组播
- **效果**：
  - ✅ 服务发现使用组播（节点之间能自动发现）
  - ✅ 数据传输使用单播（减少网络流量，提高效率）
- **优点**：平衡性能和网络开销的最佳选择

**其他可选值**：
- `true`：所有通信都使用组播（网络流量大）
- `false`：完全禁用组播（需要手动配置节点地址）
- `default`：使用系统默认设置

### `<NetworkInterface name="..." priority="default" multicast="default"/>`

#### `name` 属性
- **必需**：是
- **值**：网络接口名称
- **示例**：`eth0`, `eth10`, `wlan0`, `enp3s0`
- **查看接口**：`ip addr show`

#### `priority` 属性
- **必需**：否
- **值**：`default` 或数值（如 `10`, `20`）
- **默认值**：`default`
- **用途**：当有多个网络接口时，设置优先级
- **说明**：数值越大优先级越高

#### `multicast` 属性
- **必需**：否
- **值**：`default`, `true`, `false`
- **默认值**：`default`
- **用途**：控制该接口是否使用组播
- **推荐**：使用 `default`，由 `<AllowMulticast>` 统一控制

## 为什么不需要 `RMW_IMPLEMENTATION`？

```bash
# ❌ 本项目不需要这个变量
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
```

### 原因说明

- **RMW_IMPLEMENTATION** 是 **ROS 2** 使用的环境变量
- 用途：告诉 ROS 2 使用哪个 DDS 实现（CycloneDDS, FastDDS, Connext 等）
- **unitree_sdk2 直接使用 CycloneDDS**，不通过 ROS 2 的 RMW 层
- 因此不需要设置此变量

### 使用场景对比

| 项目类型 | 需要的环境变量 | 原因 |
|---------|--------------|------|
| ROS 2 项目 | `RMW_IMPLEMENTATION` + `CYCLONEDDS_URI` | ROS 2 通过 RMW 层访问 DDS |
| unitree_sdk2 | 仅需要 `CYCLONEDDS_URI` | 直接使用 CycloneDDS API |
| 纯 CycloneDDS | 仅需要 `CYCLONEDDS_URI` | 直接使用 CycloneDDS API |

## 已更新的文件

所有相关脚本和配置文件已更新为统一格式：

### ✅ 已更新的脚本
1. `run_with_network_interface.sh` - 通用网络接口运行脚本
2. `run_with_eth10.sh` - eth10 专用运行脚本
3. `generate_dds_config.sh` - 配置生成器

### ✅ 已更新的配置文件
1. `cyclonedds_eth10.xml` - eth10 的 XML 配置

### ✅ 自动生成的文件
使用 `generate_dds_config.sh` 生成的所有配置文件和脚本都会使用标准格式。

## 使用示例

### 示例 1：使用 eth10 接口

```bash
# 方法 1：使用环境变量
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><AllowMulticast>spdp</AllowMulticast><Interfaces><NetworkInterface name="eth10" priority="default" multicast="default"/></Interfaces></General></Domain></CycloneDDS>'
../../build/bin/lowcmd_publisher

# 方法 2：使用配置文件
export CYCLONEDDS_URI=file://$PWD/cyclonedds_eth10.xml
../../build/bin/lowcmd_publisher

# 方法 3：使用运行脚本（推荐）
./run_with_eth10.sh publisher
```

### 示例 2：使用 eth0 接口

```bash
# 方法 1：使用通用脚本
./run_with_network_interface.sh eth0 publisher

# 方法 2：生成 eth0 专用脚本
./generate_dds_config.sh eth0
./run_with_eth0.sh publisher
```

### 示例 3：使用 wlan0 接口

```bash
# 使用通用脚本
./run_with_network_interface.sh wlan0 subscriber
./run_with_network_interface.sh wlan0 publisher
```

## 配置验证

### 检查环境变量是否设置

```bash
echo $CYCLONEDDS_URI
```

### 测试配置是否生效

```bash
# 终端 1：启动订阅者（会显示配置信息）
./run_with_network_interface.sh eth10 subscriber

# 终端 2：启动发布者
./run_with_network_interface.sh eth10 publisher

# 终端 3：监控网络流量
sudo tcpdump -i eth10 -n 'udp portrange 7400-7419'
```

## 配置对比

### 旧格式（已废弃）

```bash
# ❌ 旧格式（缺少 AllowMulticast 配置）
export CYCLONEDDS_URI="<CycloneDDS><Domain><General><Interfaces><NetworkInterface name=\"eth10\" priority=\"default\" multicast=\"true\"/></Interfaces></General></Domain></CycloneDDS>"
```

**问题**：
- 缺少 `<AllowMulticast>` 配置
- `multicast="true"` 会对所有通信使用组播（包括数据传输）
- 网络流量较大

### 新格式（推荐）

```bash
# ✅ 新格式（包含完整配置）
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><AllowMulticast>spdp</AllowMulticast><Interfaces><NetworkInterface name="eth10" priority="default" multicast="default"/></Interfaces></General></Domain></CycloneDDS>'
```

**优点**：
- 包含 `<AllowMulticast>spdp</AllowMulticast>` 配置
- 仅在服务发现时使用组播
- 数据传输使用单播，减少网络流量
- 更高效的网络使用

## 故障排查

### 问题 1：配置不生效

**检查清单**：
1. 确认环境变量已设置：`echo $CYCLONEDDS_URI`
2. 确认网络接口存在：`ip addr show eth10`
3. 检查防火墙设置：`sudo ./check_network.sh`
4. 启用 DDS 日志查看详细信息

### 问题 2：无法跨机器通信

**检查清单**：
1. 防火墙是否开放 7400-7419 端口：`sudo ./setup_firewall.sh`
2. 两台机器是否在同一局域网
3. 网络接口配置是否正确
4. 使用 tcpdump 监控网络流量

### 问题 3：同一机器指定不同接口仍能通信

**原因**：这是 DDS 的正常行为
- DDS 在同一机器上会使用共享内存或 localhost
- 网络接口配置主要用于跨机器通信
- 要测试接口隔离，必须使用两台不同的机器

## 快速参考

### 查看可用网络接口
```bash
ip addr show
```

### 设置环境变量（eth10）
```bash
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><AllowMulticast>spdp</AllowMulticast><Interfaces><NetworkInterface name="eth10" priority="default" multicast="default"/></Interfaces></General></Domain></CycloneDDS>'
```

### 使用脚本运行（推荐）
```bash
./run_with_network_interface.sh eth10 subscriber
./run_with_network_interface.sh eth10 publisher
```

### 生成自定义配置
```bash
./generate_dds_config.sh eth10
```

## 相关文档

- [DDS配置说明.md](./DDS配置说明.md) - 详细的 DDS 配置指南
- [局域网通信问题解决方案.md](./局域网通信问题解决方案.md) - 故障排查指南
- [network_interface_issue.md](./network_interface_issue.md) - 网络接口问题说明
- [README.md](./README.md) - 项目主文档
