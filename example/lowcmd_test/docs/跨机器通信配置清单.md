# 跨机器 DDS 通信配置清单

## 前提条件

两台机器必须：
- ✅ 在同一个局域网（能互相 ping 通）
- ✅ 使用相同类型的网络接口
- ✅ 使用相同的 DDS 配置
- ✅ 都开放 DDS 端口（7400-7419/udp）

---

## 配置步骤

### 机器 A（发布者）

#### 1. 检查网络接口

```bash
# 列出所有网络接口
ip addr show

# 选择要使用的接口（假设是 wlp2s0）
INTERFACE="wlp2s0"

# 查看接口 IP
ip addr show $INTERFACE | grep "inet "
```

#### 2. 配置防火墙

```bash
cd /mine/Code/unitree/unitree_sdk2/example/lowcmd_test

# 自动配置防火墙
sudo ./setup_firewall.sh

# 验证规则
sudo ufw status | grep 7400
```

#### 3. 运行发布者

```bash
# 使用物理网卡
./run_with_network_interface.sh wlp2s0 publisher

# 或使用 Tailscale VPN
./quick_test_tailscale.sh  # 选择 2 (发布者)
```

---

### 机器 B（订阅者）

#### 1. 检查网络接口（必须与机器 A 相同类型）

```bash
# 列出所有网络接口
ip addr show

# 使用与机器 A 相同类型的接口
INTERFACE="wlp2s0"  # 必须与机器 A 一致

# 查看接口 IP
ip addr show $INTERFACE | grep "inet "
```

#### 2. 配置防火墙

```bash
cd /mine/Code/unitree/unitree_sdk2/example/lowcmd_test

# 自动配置防火墙
sudo ./setup_firewall.sh

# 验证规则
sudo ufw status | grep 7400
```

#### 3. 测试网络连通性

```bash
# ping 机器 A 的 IP（替换为实际 IP）
ping -c 3 192.168.1.100

# 如果 ping 不通，检查：
# 1. 两台机器是否在同一个网络
# 2. 路由器设置
# 3. 网络隔离设置
```

#### 4. 运行订阅者

```bash
# 使用物理网卡
./run_with_network_interface.sh wlp2s0 subscriber

# 或使用 Tailscale VPN
./quick_test_tailscale.sh  # 选择 1 (订阅者)
```

---

## 验证通信

### 订阅者端应该看到：

```
========================================
接收到 LowCmd 消息 #1
时间戳: 1763797005795 ms
控制模式:
  mode_pr: 0 (0:PR, 1:AB)
  mode_machine: 5 (4:23-DOF, 5:29-DOF, 6:27-DOF)
...
```

### 发布者端应该看到：

```
开始发布 LowCmd 消息...
已发布 100 条消息
已发布 200 条消息
...
```

---

## 故障排查

### 问题 1：订阅者收不到消息

**检查清单：**

```bash
# 1. 两台机器能否互相 ping 通？
ping <对方 IP>

# 2. 防火墙是否开放？
sudo ufw status | grep 7400

# 3. DDS 端口是否监听？
sudo netstat -ulnp | grep -E "740[0-9]|741[0-9]"

# 4. 使用的网络接口是否正确？
ip addr show wlp2s0  # 替换为实际接口名

# 5. 运行故障排查脚本
sudo ./troubleshoot_network.sh wlp2s0 <对方 IP>
```

### 问题 2：网络接口类型不匹配

**症状：** 一台机器使用物理网卡，另一台使用 VPN

**解决方法：** 统一使用相同类型的网络接口

```bash
# 选项 A：都使用物理网卡（推荐）
机器 A: ./run_with_network_interface.sh wlp2s0 publisher
机器 B: ./run_with_network_interface.sh wlp2s0 subscriber

# 选项 B：都使用 Tailscale VPN
机器 A: ./quick_test_tailscale.sh  # 选择发布者
机器 B: ./quick_test_tailscale.sh  # 选择订阅者
```

### 问题 3：防火墙阻止通信

**检查防火墙状态：**

```bash
# Ubuntu/Debian
sudo ufw status verbose

# CentOS/RHEL
sudo firewall-cmd --list-all

# 查看是否有 7400-7419/udp 规则
```

**手动配置防火墙：**

```bash
# Ubuntu/Debian
sudo ufw allow 7400:7419/udp
sudo ufw reload

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=7400-7419/udp
sudo firewall-cmd --reload
```

### 问题 4：DDS 配置不一致

**确保两台机器使用相同的配置：**

```bash
# 检查当前 DDS 配置
echo $CYCLONEDDS_URI

# 应该在两台机器上看到类似的配置：
# <CycloneDDS><Domain><General><AllowMulticast>spdp</AllowMulticast>...
```

**重要：** 如果使用 Tailscale VPN，必须**禁用组播**：

```bash
# ❌ 错误配置（Tailscale 不支持组播）
<AllowMulticast>spdp</AllowMulticast>

# ✅ 正确配置（Tailscale 必须使用单播）
<AllowMulticast>false</AllowMulticast>
```

### 问题 5：路由器隔离设置

有些路由器启用了 **AP 隔离** 或 **客户端隔离**，会阻止局域网内设备互相通信。

**检查方法：**

```bash
# 测试两台机器能否互相 ping 通
ping <对方 IP>
```

**如果 ping 不通：**
1. 登录路由器管理界面
2. 查找 "AP 隔离" 或 "Client Isolation" 设置
3. 确保该功能已禁用

---

## 网络拓扑示例

### 场景 1：物理网卡（推荐）

```
路由器 (192.168.1.1)
    │
    ├─ 机器 A (192.168.1.100) - wlp2s0
    │   └─ 发布者: ./run_with_network_interface.sh wlp2s0 publisher
    │
    └─ 机器 B (192.168.1.101) - wlp2s0
        └─ 订阅者: ./run_with_network_interface.sh wlp2s0 subscriber
```

### 场景 2：Tailscale VPN

```
Tailscale 网络
    │
    ├─ 机器 A (100.81.1.83) - tailscale0
    │   └─ 发布者: ./quick_test_tailscale.sh (选择 2)
    │
    └─ 机器 B (100.81.1.100) - tailscale0
        └─ 订阅者: ./quick_test_tailscale.sh (选择 1)
```

### ❌ 错误场景：混用网络接口

```
路由器 (192.168.1.1)        Tailscale 网络
    │                           │
    └─ 机器 A (192.168.1.100)   └─ 机器 B (100.81.1.100)
        wlp2s0 ❌ ────────────× ❌ tailscale0
        
不同网络，无法通信！
```

---

## 监控网络流量

### 在订阅者机器上监控 DDS 流量

```bash
# 打开新终端
sudo tcpdump -i wlp2s0 -n 'udp portrange 7400-7419' -v

# 如果看到数据包，说明网络通信正常
# 如果看不到数据包，说明：
#   1. 发布者没有发送消息
#   2. 防火墙阻止
#   3. 网络路由问题
```

### 在发布者机器上监控发送

```bash
# 打开新终端
sudo tcpdump -i wlp2s0 -n 'udp portrange 7400-7419' -v

# 应该看到发送出去的数据包
```

---

## 快速诊断脚本

运行自动诊断：

```bash
# 在机器 A 上
sudo ./troubleshoot_network.sh wlp2s0 192.168.1.101

# 在机器 B 上
sudo ./troubleshoot_network.sh wlp2s0 192.168.1.100
```

脚本会检查：
- ✅ 网络接口状态
- ✅ IP 地址和路由
- ✅ 防火墙规则
- ✅ DDS 端口监听
- ✅ 与对方的网络连通性
- ✅ 当前 DDS 配置

---

## 常见配置错误

### 错误 1：只在一台机器上配置了防火墙

```bash
# ❌ 错误：只在机器 A 配置
机器 A: sudo ./setup_firewall.sh  ✅
机器 B: （未配置）❌

# ✅ 正确：两台都要配置
机器 A: sudo ./setup_firewall.sh  ✅
机器 B: sudo ./setup_firewall.sh  ✅
```

### 错误 2：使用了不兼容的网络接口

```bash
# ❌ 错误
机器 A: ./run_with_network_interface.sh eth0 publisher
机器 B: ./run_with_network_interface.sh tailscale0 subscriber

# ✅ 正确
机器 A: ./run_with_network_interface.sh eth0 publisher
机器 B: ./run_with_network_interface.sh eth0 subscriber
```

### 错误 3：DDS 配置不一致

```bash
# ❌ 错误：机器 A 使用组播，机器 B 禁用组播
机器 A: CYCLONEDDS_URI='...<AllowMulticast>spdp</AllowMulticast>...'
机器 B: CYCLONEDDS_URI='...<AllowMulticast>false</AllowMulticast>...'

# ✅ 正确：两台使用相同配置
机器 A: CYCLONEDDS_URI='...<AllowMulticast>spdp</AllowMulticast>...'
机器 B: CYCLONEDDS_URI='...<AllowMulticast>spdp</AllowMulticast>...'
```

---

## 测试清单

在开始测试前，确认所有项目：

**网络连通性：**
- [ ] 两台机器可以互相 ping 通
- [ ] 使用相同类型的网络接口（都是物理网卡或都是 VPN）
- [ ] 路由器未启用 AP 隔离

**防火墙配置：**
- [ ] 机器 A 已开放 7400-7419/udp 端口
- [ ] 机器 B 已开放 7400-7419/udp 端口
- [ ] 使用 `sudo ufw status` 验证

**DDS 配置：**
- [ ] 两台机器使用相同的 `CYCLONEDDS_URI` 配置
- [ ] 网络接口名称正确
- [ ] 如果使用 Tailscale，已禁用组播（`AllowMulticast>false`）

**程序运行：**
- [ ] 程序已编译（`./build.sh`）
- [ ] 先启动订阅者，再启动发布者
- [ ] 使用正确的网络接口参数

如果所有项目都确认，通信应该可以正常工作！

---

## 相关文档

- `troubleshoot_network.sh` - 自动故障排查工具
- `setup_firewall.sh` - 防火墙配置脚本
- `局域网通信问题解决方案.md` - 详细的故障排查指南
- `DDS配置说明.md` - DDS 配置参数说明
