# 局域网通信问题解决方案

## 问题描述

如果在局域网中运行 `lowcmd_publisher` 和 `lowcmd_subscriber` 无法通信，最常见的原因是**防火墙阻止了 DDS 通信**。

## 解决方案

### 方案 1：快速配置防火墙（推荐）

使用提供的自动配置脚本：

```bash
# 运行防火墙配置脚本
cd /mine/Code/unitree/unitree_sdk2/example/lowcmd_test
sudo ./setup_firewall.sh
```

这个脚本会自动检测你的防火墙类型（UFW 或 firewalld）并开放必要的端口。

### 方案 2：手动配置防火墙

#### Ubuntu/Debian (UFW)

```bash
# 开放 DDS 通信端口
sudo ufw allow 7400:7419/udp

# 查看防火墙状态
sudo ufw status

# 如果防火墙未启用，可以启用它
sudo ufw enable
```

#### CentOS/RHEL (firewalld)

```bash
# 开放 DDS 通信端口
sudo firewall-cmd --permanent --add-port=7400-7419/udp
sudo firewall-cmd --reload

# 查看防火墙规则
sudo firewall-cmd --list-all
```

#### 临时关闭防火墙测试（不推荐生产环境）

```bash
# Ubuntu/Debian
sudo ufw disable

# CentOS/RHEL
sudo systemctl stop firewalld
```

### 方案 3：诊断网络问题

使用诊断脚本检查网络配置：

```bash
cd /mine/Code/unitree/unitree_sdk2/example/lowcmd_test
sudo ./check_network.sh
```

这个脚本会检查：
- 网络接口配置
- 防火墙状态
- DDS 端口占用情况
- 组播支持情况

## DDS 通信原理

CycloneDDS 使用以下机制进行通信：

1. **UDP 端口范围**：7400-7419
2. **组播地址**：239.255.0.1（用于服务发现）
3. **默认发现端口**：7410

## 跨机器通信配置

### 机器 A（发布者）

```bash
# 查看网络接口
ip addr show

# 运行发布者，指定正确的网络接口
./build/bin/lowcmd_publisher eth0  # 替换为实际接口名
```

### 机器 B（订阅者）

```bash
# 运行订阅者，确保能访问机器 A 的网络
./build/bin/lowcmd_subscriber eth0  # 替换为实际接口名
```

### 使用环境变量强制指定网络接口

如果命令行参数不生效，可以使用环境变量：

```bash
# 方法 1：使用环境变量
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><Interfaces><NetworkInterface name="eth0" priority="default" multicast="true"/></Interfaces></General></Domain></CycloneDDS>'
./build/bin/lowcmd_publisher

# 方法 2：使用配置文件
export CYCLONEDDS_URI=file://$PWD/cyclonedds_config.xml
./build/bin/lowcmd_publisher
```

### 创建 DDS 配置文件

创建 `cyclonedds_config.xml`：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CycloneDDS xmlns="https://cdds.io/config">
  <Domain>
    <General>
      <Interfaces>
        <!-- 替换为实际的网络接口名 -->
        <NetworkInterface name="eth0" priority="default" multicast="true"/>
      </Interfaces>
      <!-- 可选：启用详细日志用于调试 -->
      <!-- <Tracing><Verbosity>finest</Verbosity></Tracing> -->
    </General>
  </Domain>
</CycloneDDS>
```

## 常见问题

### Q1: 防火墙已配置，但仍无法通信？

**答**：检查以下几点：
1. 确认两台机器在同一个局域网
2. 检查路由器是否阻止了组播流量
3. 使用 `ping` 测试两台机器是否能互相访问
4. 检查是否指定了正确的网络接口

```bash
# 测试网络连通性
ping <对方机器IP>

# 检查路由
ip route show
```

### Q2: 在同一台机器上为什么指定不同网络接口还能通信？

**答**：这是 DDS 的设计特性。在同一台机器上，DDS 会自动使用：
- **共享内存传输**：绕过网络栈，直接通过内存通信
- **Localhost (127.0.0.1)**：即使禁用共享内存也会通过本地回环通信

这是为了提供最佳性能。要真正测试网络接口隔离，必须使用**两台不同的机器**。

### Q3: 如何确认 DDS 是否正在使用正确的网络接口？

**答**：使用 tcpdump 或 wireshark 监控网络流量：

```bash
# 监控指定网络接口的 DDS 流量
sudo tcpdump -i eth0 -n udp port 7410

# 或者监控所有 DDS 端口
sudo tcpdump -i eth0 -n 'udp portrange 7400-7419'
```

### Q4: 多网卡环境下如何选择正确的接口？

**答**：
1. 查看所有网络接口及其 IP：
   ```bash
   ip addr show
   ```

2. 确定哪个接口连接到目标局域网

3. 明确指定该接口：
   ```bash
   ./build/bin/lowcmd_publisher <接口名>
   ```

## 测试步骤

### 完整测试流程

1. **准备两台机器**（机器 A 和机器 B）

2. **在两台机器上配置防火墙**：
   ```bash
   sudo ./setup_firewall.sh
   ```

3. **在机器 A 上运行诊断**：
   ```bash
   sudo ./check_network.sh
   ```

4. **在机器 A 上启动订阅者**：
   ```bash
   ./build/bin/lowcmd_subscriber eth0
   ```

5. **在机器 B 上启动发布者**：
   ```bash
   ./build/bin/lowcmd_publisher eth0
   ```

6. **观察订阅者是否收到消息**

如果仍无法通信，使用 tcpdump 检查网络流量：

```bash
# 在机器 A 上监控
sudo tcpdump -i eth0 -n 'udp portrange 7400-7419'
```

## 高级配置

### 禁用共享内存（仅用于调试）

如果需要在同一台机器上测试网络接口（不推荐），可以禁用共享内存：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CycloneDDS xmlns="https://cdds.io/config">
  <Domain>
    <General>
      <Interfaces>
        <NetworkInterface name="eth0"/>
      </Interfaces>
      <!-- 禁用共享内存 -->
      <SharedMemory>
        <Enable>false</Enable>
      </SharedMemory>
    </General>
  </Domain>
</CycloneDDS>
```

### 启用 DDS 日志

添加详细日志以排查问题：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CycloneDDS xmlns="https://cdds.io/config">
  <Domain>
    <General>
      <Interfaces>
        <NetworkInterface name="eth0"/>
      </Interfaces>
    </General>
    <Tracing>
      <Verbosity>finest</Verbosity>
      <OutputFile>dds.log</OutputFile>
    </Tracing>
  </Domain>
</CycloneDDS>
```

## 参考资料

- [CycloneDDS 官方文档](https://github.com/eclipse-cyclonedds/cyclonedds)
- [DDS 配置指南](https://github.com/eclipse-cyclonedds/cyclonedds/blob/master/docs/manual/config.rst)
- 本地文档：`network_interface_issue.md`

## 联系支持

如果以上方法都无法解决问题，建议：
1. 检查日志文件（启用 DDS 日志）
2. 确认网络硬件配置（交换机、路由器）
3. 联系 Unitree 官方技术支持
